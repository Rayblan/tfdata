<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
       .title-container {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .author-link {
            position: absolute;
            right: -180px;
            bottom: 15px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .author-link:hover {
            color: #ffcc66;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            text-decoration: none;
        }
        
        @media (max-width: 768px) {
            .title-container {
                display: block;
                text-align: center;
            }
            
            .author-link {
                position: static;
                display: block;
                margin-top: 5px;
                right: auto;
                bottom: auto;
            }
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-attachment: fixed;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-right: 50px;
            margin-left: 50px;

        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .search-box {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            max-width: 500px;
            padding: 15px 20px;
            padding-left: 45px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            left: calc(50% - 230px);
            top: 15px;
            color: #666;
        }
        
        .main-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .main-tab {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            border: 2px solid transparent;
        }
        
        .main-tab:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .main-tab.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: #ff9900;
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        }
        
        .category-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }
        
        .category-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            border: 1px solid transparent;
        }
        
        .category-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .category-tab.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: #ff9900;
        }
        
        .weapons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .weapon-card {
            background: linear-gradient(145deg, #2c3e50, #1a2530);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            position: relative;
        }
        
        .weapon-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }
        
        .weapon-card.selected {
            border: 2px solid #ff9900;
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.7);
        }
        
        .compare-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            z-index: 10;
        }
        
        .card-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .weapon-name {
            font-size: 1.6rem;
            margin-bottom: 5px;
            color: #ff9900;
        }
        
        .weapon-type {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .weapon-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .melee-damage {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: #ff9900;
            padding: 15px 0;
        }

        .melee-damage-info {
            font-size: 0.9rem;
            color: #ccc;
            margin-top: 5px;
        }

        .ranking-table .melee-weapon {
            opacity: 0.6;
            background: rgba(255, 153, 0, 0.1);
        }

        .ranking-table .melee-weapon td {
            font-style: italic;
        }

        .ranking-section {
            margin: 40px 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            padding: 25px;
        }
        
        .ranking-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            gap: 15px;
        }
        
        .ranking-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ranking-tab.active {
            background: rgba(255, 153, 0, 0.3);
            font-weight: bold;
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .ranking-table th, .ranking-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ranking-table th {
            background: rgba(255, 153, 0, 0.2);
            font-weight: bold;
        }
        
        .ranking-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .ranking-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .rank-number {
            font-weight: bold;
            text-align: center;
            width: 50px;
        }
        
        .rank-1 {
            color: gold;
            font-size: 1.2em;
        }
        
        .rank-2 {
            color: silver;
        }
        
        .rank-3 {
            color: #cd7f32; /* Bronze */
        }
        
        .ttk-value {
            font-weight: bold;
        }
        
        .compare-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        .compare-btn {
            padding: 12px 25px;
            background: #ff9900;
            color: #000;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .compare-btn:hover {
            background: #ffaa33;
        }
        
        .compare-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .selected-count {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .compare-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 1200px;
            max-height: 85vh;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 12px;
            z-index: 200;
            padding: 30px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.7);
        }
        
        .compare-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .compare-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .compare-table th, .compare-table td {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .compare-table th {
            background: rgba(255, 153, 0, 0.2);
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .compare-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .best-value {
            background: rgba(0, 255, 0, 0.15);
            font-weight: bold;
        }
        
        .worst-value {
            background: rgba(255, 0, 0, 0.15);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        
        .no-results {
            text-align: center;
            grid-column: 1 / -1;
            padding: 40px;
            font-size: 1.2rem;
        }
        
        @media (max-width: 768px) {
            .weapons-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .search-input {
                padding: 12px 15px;
                padding-left: 40px;
            }
            
            .search-icon {
                left: calc(50% - 165px);
            }
            
            .compare-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .compare-table {
                font-size: 0.8rem;
            }
            
            .compare-table th, .compare-table td {
                padding: 8px 6px;
            }
        }
        .sort-controls {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.sort-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.sort-group label {
    font-weight: bold;
    color: #fff;
}

.sort-select {
    padding: 8px 15px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    background-color: #232323;
    color: #fff;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.sort-select option {
    background-color: #232323;
    color: #fff;
}

.sort-select:hover,
.sort-select:focus {
    background-color: #232323;
    border-color: #ff9900;
    box-shadow: 0 0 0 2px rgba(255, 153, 0, 0.2);
}

@media (max-width: 768px) {
    .sort-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .sort-group {
        flex-direction: column;
        text-align: center;
    }
}
    </style>
</head>
<body>
    <div id="app" class="container">
        <header>
            <div class="title-container">
            <h1>THE FINALS 武器数据库</h1>
            <a href="https://space.bilibili.com/85550309" class="author-link" target="_blank">
                <i class="fas fa-pencil-alt"></i> B站: 哥布林纯水，欢迎关注
            </a>
    </div>
            <p class="subtitle">浏览和比较游戏中的所有武器数据</p>
            
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input class="search-input" v-model="searchQuery" placeholder="搜索武器名称..." />
            </div>
        </header>
        
        <div class="main-tabs">
            <div class="main-tab" :class="{ active: activeView === 'list' }" @click="activeView = 'list'">
                武器列表
            </div>
            <div class="main-tab" :class="{ active: activeView === 'ranking' }" @click="activeView = 'ranking'">
                击杀速度排名
            </div>
        </div>
        
        <div v-if="activeView === 'list'">
            <div class="category-tabs">
                <div v-for="category in categories" :key="category" 
                     :class="['category-tab', activeCategory === category ? 'active' : '']"
                     @click="activeCategory = category">
                    {{ category }}
                </div>
            </div>
            <div class="sort-controls">
    <div class="sort-group">
        <label>排序方式：</label>
        <select v-model="sortBy" class="sort-select">
            <option value="name">武器名称</option>
            <option value="body">身体伤害</option>
            <option value="head">头部伤害</option>
            <option value="rpm">射速 (RPM)</option>
            <option value="magazine">弹匣容量</option>
        </select>
    </div>
    <div class="sort-group">
        <label>排序顺序：</label>
        <select v-model="sortDirection" class="sort-select">
            <option value="asc">升序</option>
            <option value="desc">降序</option>
        </select>
    </div>
</div>
            
            <div class="weapons-grid">
                <div v-for="weapon in filteredWeapons" :key="weapon.weapon_name" 
                     class="weapon-card" :class="{ selected: isSelected(weapon) }"
                     @click="toggleWeaponSelection(weapon)">
                    <input type="checkbox" class="compare-checkbox" :checked="isSelected(weapon)" />
                    <div class="card-header">
                        <div class="weapon-name">{{ weapon.weapon_name }}</div>
                        <div class="weapon-type">{{ weapon.infobox.Type }} - {{ weapon.infobox.Build }}</div>
                    </div>
                    <div class="card-body">
                        <div v-if="getMeleeDamage(weapon)" class="melee-damage">
                            {{ getMeleeDamage(weapon) }}
                        </div>
                        <div v-else class="weapon-stats">
                            <div class="stat-item">
                                <span class="stat-label">身体伤害</span>
                                <span class="stat-value">{{ weapon.infobox.Body }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">头部伤害</span>
                                <span class="stat-value">{{ weapon.infobox.Head || 'N/A' }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">射速 (RPM)</span>
                                <span class="stat-value">{{ weapon.infobox.RPM || 'N/A' }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">弹匣容量</span>
                                <span class="stat-value">{{ weapon.infobox.Magazine || 'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="filteredWeapons.length === 0" class="no-results">
                    没有找到匹配的武器
                </div>
            </div>
            
            <div class="compare-section" v-if="selectedWeapons.length > 0">
                <div class="selected-count">已选择 {{ selectedWeapons.length }} 把武器进行对比</div>
                <button class="compare-btn" @click="showCompareModal">对比武器</button>
                <button class="compare-btn" @click="clearSelection">清空选择</button>
            </div>
        </div>
        
        <div v-if="activeView === 'ranking'">
            <div class="ranking-tabs">
                <div class="ranking-tab" :class="{ active: activeRanking === 'light' }" @click="activeRanking = 'light'">
                    轻型目标 (150HP)
                </div>
                <div class="ranking-tab" :class="{ active: activeRanking === 'medium' }" @click="activeRanking = 'medium'">
                    中型目标 (250HP)
                </div>
                <div class="ranking-tab" :class="{ active: activeRanking === 'heavy' }" @click="activeRanking = 'heavy'">
                    重型目标 (350HP)
                </div>
            </div>
            
            <div class="ranking-section">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>武器名称</th>
                            <th>类型</th>
                            <th>身体击杀时间</th>
                            <th>头部击杀时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(weapon, index) in rankedWeapons" :key="weapon.weapon_name" 
                            :class="{'melee-weapon': isMeleeWeapon(weapon)}">
                            <td class="rank-number" :class="'rank-' + (index + 1)">
                                {{ isMeleeWeapon(weapon) ? '-' : index + 1 }}
                            </td>
                            <td>{{ weapon.weapon_name }}</td>
                            <td>{{ weapon.infobox.Type }}</td>
                            <td class="ttk-value">
                                {{ isMeleeWeapon(weapon) ? '近战武器' : getBodyTTK(weapon) + '秒' }}
                            </td>
                            <td class="ttk-value">
                                {{ isMeleeWeapon(weapon) ? '近战武器' : getHeadTTK(weapon) + '秒' }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="compare-modal" v-if="showCompare">
            <div class="compare-header">
                <h2>武器对比</h2>
                <button class="compare-btn" @click="showCompare = false">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
            <table class="compare-table">
                <thead>
                    <tr>
                        <th>属性</th>
                        <th v-for="weapon in selectedWeapons" :key="weapon.weapon_name">
                            {{ weapon.weapon_name }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>类型</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-type'">
                            {{ weapon.infobox.Type }}
                        </td>
                    </tr>
                    <tr>
                        <td>适用职业</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-build'">
                            {{ weapon.infobox.Build }}
                        </td>
                    </tr>
                    <tr>
                        <td>身体伤害</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-body'"
                            :class="getBestValueClass(selectedWeapons, 'Body', weapon, 'max')">
                            {{ weapon.infobox.Body }}
                        </td>
                    </tr>
                    <tr>
                        <td>头部伤害</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-head'"
                            :class="getBestValueClass(selectedWeapons, 'Head', weapon, 'max')">
                            {{ weapon.infobox.Head }}
                        </td>
                    </tr>
                    <tr>
                        <td>射速 (RPM)</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-rpm'"
                            :class="getBestValueClass(selectedWeapons, 'RPM', weapon, 'max')">
                            {{ weapon.infobox.RPM }}
                        </td>
                    </tr>
                    <tr>
                        <td>弹匣容量</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-mag'"
                            :class="getBestValueClass(selectedWeapons, 'Magazine', weapon, 'max')">
                            {{ weapon.infobox.Magazine }}
                        </td>
                    </tr>
                    <tr>
                        <td>最小射程</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-minrange'"
                            :class="getBestValueClass(selectedWeapons, 'Min Range', weapon, 'max')">
                            {{ weapon.infobox['Min Range'] || 'N/A' }}
                        </td>
                    </tr>
                    <tr>
                        <td>最大射程</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-maxrange'"
                            :class="getBestValueClass(selectedWeapons, 'Max Range', weapon, 'max')">
                            {{ weapon.infobox['Max Range'] || 'N/A' }}
                        </td>
                    </tr>
                    <tr>
                        <td>伤害倍率</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-multiplier'"
                            :class="getBestValueClass(selectedWeapons, 'Multiplier', weapon, 'max')">
                            {{ weapon.infobox['Multiplier'] || 'N/A' }}
                        </td>
                    </tr>
                    <tr>
                        <td>空仓换弹</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-empty'"
                            :class="getBestValueClass(selectedWeapons, 'Empty Reload', weapon, 'min')">
                            {{ weapon.infobox['Empty Reload'] || 'N/A' }}
                        </td>
                    </tr>
                    <tr>
                        <td>战术换弹</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-tactical'"
                            :class="getBestValueClass(selectedWeapons, 'Tactical Reload', weapon, 'min')">
                            {{ weapon.infobox['Tactical Reload'] || 'N/A' }}
                        </td>
                    </tr>
                    <tr>
                        <td>轻型身体TTK</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-light-body'"
                            :class="getBestTTKClass(selectedWeapons, 'light', 'body', weapon)">
                            {{ getBodyTTK(weapon, 'light') }}秒
                        </td>
                    </tr>
                    <tr>
                        <td>轻型头部TTK</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-light-head'"
                            :class="getBestTTKClass(selectedWeapons, 'light', 'head', weapon)">
                            {{ getHeadTTK(weapon, 'light') }}秒
                        </td>
                    </tr>
                    <tr>
                        <td>中型身体TTK</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-medium-body'"
                            :class="getBestTTKClass(selectedWeapons, 'medium', 'body', weapon)">
                            {{ getBodyTTK(weapon, 'medium') }}秒
                        </td>
                    </tr>
                    <tr>
                        <td>中型头部TTK</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-medium-head'"
                            :class="getBestTTKClass(selectedWeapons, 'medium', 'head', weapon)">
                            {{ getHeadTTK(weapon, 'medium') }}秒
                        </td>
                    </tr>
                    <tr>
                        <td>重型身体TTK</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-heavy-body'"
                            :class="getBestTTKClass(selectedWeapons, 'heavy', 'body', weapon)">
                            {{ getBodyTTK(weapon, 'heavy') }}秒
                        </td>
                    </tr>
                    <tr>
                        <td>重型头部TTK</td>
                        <td v-for="weapon in selectedWeapons" :key="weapon.weapon_name + '-heavy-head'"
                            :class="getBestTTKClass(selectedWeapons, 'heavy', 'head', weapon)">
                            {{ getHeadTTK(weapon, 'heavy') }}秒
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="overlay" :class="{ active: showCompare }" @click="showCompare = false"></div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        
        createApp({
            setup() {
                const weapons = ref([]);
                const searchQuery = ref('');
                const activeCategory = ref('All');
                const activeView = ref('list');
                const activeRanking = ref('light');
                const selectedWeapons = ref([]);
                const showCompare = ref(false);
                const sortBy = ref('name');
                const sortDirection = ref('asc');
                
                const categories = ['All', 'Heavy', 'Light', 'Medium'];

                // 初始化武器数据
                const initWeaponData = async () => {
                  try {
                    const response = await fetch('weaponsdata.json');
                    weapons.value = await response.json();
                  } catch (error) {
                    console.error("failed to load weapon data:", error);
                  }
                };
                
                // 过滤并排序武器列表
                const filteredWeapons = computed(() => {
                  const query = searchQuery.value.toLowerCase().trim();
                  
                  // 先过滤
                  let filtered = weapons.value.filter(weapon => {
                    const matchesCategory = activeCategory.value === 'All' || weapon.infobox.Build === activeCategory.value;
            
                    if (!query) return matchesCategory;
            
                    const nameMatch = weapon.weapon_name.toLowerCase().includes(query);
                    const aliasMatch = weapon.aliases && 
                      Array.isArray(weapon.aliases) && 
                      weapon.aliases.some(alias => 
                        alias.toLowerCase().includes(query)
                      );
                    const typeMatch = weapon.infobox.Type.toLowerCase().includes(query);
            
                    return matchesCategory && (nameMatch || aliasMatch || typeMatch);
                  });
                  
                  // 再排序
                  const sorted = [...filtered].sort((a, b) => {
                    let valueA, valueB;
                    
                    switch (sortBy.value) {
                        case 'name':
                            valueA = a.weapon_name.toLowerCase();
                            valueB = b.weapon_name.toLowerCase();
                            break;
                        case 'body':
                            valueA = parseFloat(a.infobox.Body) || 0;
                            valueB = parseFloat(b.infobox.Body) || 0;
                            break;
                        case 'head':
                            valueA = parseFloat(a.infobox.Head) || 0;
                            valueB = parseFloat(b.infobox.Head) || 0;
                            break;
                        case 'rpm':
                            valueA = parseFloat(a.infobox.RPM) || 0;
                            valueB = parseFloat(b.infobox.RPM) || 0;
                            break;
                        case 'magazine':
                            valueA = parseFloat(a.infobox.Magazine) || 0;
                            valueB = parseFloat(b.infobox.Magazine) || 0;
                            break;
                        default:
                            valueA = a.weapon_name.toLowerCase();
                            valueB = b.weapon_name.toLowerCase();
                    }
                    
                    if (sortDirection.value === 'asc') {
                        return valueA > valueB ? 1 : -1;
                    } else {
                        return valueA < valueB ? 1 : -1;
                    }
                  });
                  
                  return sorted;
                });
                
                // 检查武器是否被选中
                const isSelected = (weapon) => {
                    return selectedWeapons.value.some(w => w.weapon_name === weapon.weapon_name);
                };
                
                // 切换武器选择状态
                const toggleWeaponSelection = (weapon) => {
                    if (isSelected(weapon)) {
                        selectedWeapons.value = selectedWeapons.value.filter(w => w.weapon_name !== weapon.weapon_name);
                    } else {
                        if (selectedWeapons.value.length < 4) {
                            selectedWeapons.value.push(weapon);
                        } else {
                            alert('最多只能选择4把武器进行对比');
                        }
                    }
                };
                
                // 清空选择
                const clearSelection = () => {
                    selectedWeapons.value = [];
                };
                
                // 显示对比模态框
                const showCompareModal = () => {
                    showCompare.value = true;
                };
                
                // 获取身体击杀时间
                const getBodyTTK = (weapon, targetType = null) => {
                    const type = targetType || activeRanking.value;
                    const bodyRow = weapon.parsed_overflow.damage_data.rows.find(row => row.body_part === "Body");
                    if (bodyRow && bodyRow[type]) {
                        return parseFloat(bodyRow[type].time_to_kill);
                    }
                    return "N/A";
                };
                
                // 获取头部击杀时间
                const getHeadTTK = (weapon, targetType = null) => {
                    const type = targetType || activeRanking.value;
                    const headRow = weapon.parsed_overflow.damage_data.rows.find(row => row.body_part === "Head");
                    if (headRow && headRow[type]) {
                        return parseFloat(headRow[type].time_to_kill);
                    }
                    return "N/A";
                };
                
                // 获取最佳TTK类名
                const getBestTTKClass = (weapons, targetType, hitType, currentWeapon) => {
                    const ttkValues = weapons.map(weapon => {
                        const value = hitType === 'head' ? 
                            getHeadTTK(weapon, targetType) : 
                            getBodyTTK(weapon, targetType);
                        return typeof value === 'number' ? value : Infinity;
                    });
                    
                    const minTTK = Math.min(...ttkValues);
                    const currentTTK = hitType === 'head' ? 
                        getHeadTTK(currentWeapon, targetType) : 
                        getBodyTTK(currentWeapon, targetType);
                    
                    return typeof currentTTK === 'number' && currentTTK === minTTK ? 'best-value' : '';
                };
                
                // 获取最佳值类名
                const getBestValueClass = (weapons, property, currentWeapon, bestType = 'max') => {
                    // 处理带单位的数值（如 "3.00s", "35m"）
                    const parseValue = (value) => {
                        if (!value) return 0;
                        const num = parseFloat(value);
                        return isNaN(num) ? 0 : num;
                    };
                    
                    const values = weapons.map(weapon => parseValue(weapon.infobox[property]));
                    
                    let bestValue;
                    if (bestType === 'max') {
                        bestValue = Math.max(...values);
                    } else {
                        bestValue = Math.min(...values);
                    }
                    
                    const currentValue = parseValue(currentWeapon.infobox[property]);
                    
                    if (currentValue === bestValue && bestValue !== 0) {
                        return 'best-value';
                    }
                    
                    // 对于换弹时间等需要最小值的属性，标记最差值
                    if (bestType === 'min' && currentValue === Math.max(...values)) {
                        return 'worst-value';
                    }
                    
                    return '';
                };
                
                // 按击杀时间排序的武器列表（排除近战武器）
                const rankedWeapons = computed(() => {
                    // 过滤出非近战武器
                    const nonMeleeWeapons = weapons.value.filter(weapon => 
                        weapon.infobox.Type !== "近战 Melee" && 
                        weapon.infobox.Type !== "Melee"
                    );
                    
                    // 过滤出近战武器
                    const meleeWeapons = weapons.value.filter(weapon => 
                        weapon.infobox.Type === "近战 Melee" || 
                        weapon.infobox.Type === "Melee"
                    );
                    
                    // 对非近战武器进行排序
                    const sortedNonMelee = [...nonMeleeWeapons].sort((a, b) => {
                        const aTTK = getBodyTTK(a, activeRanking.value);
                        const bTTK = getBodyTTK(b, activeRanking.value);
                        
                        if (typeof aTTK !== 'number') return 1;
                        if (typeof bTTK !== 'number') return -1;
                        
                        return aTTK - bTTK;
                    });
                    
                    // 将近战武器放在最后
                    return [...sortedNonMelee, ...meleeWeapons];
                });
                
                // 检查是否为近战武器
                const isMeleeWeapon = (weapon) => {
                    return weapon.infobox.Type === "近战 Melee" || 
                           weapon.infobox.Type === "Melee" ||
                           weapon.infobox.Type.includes("近战");
                };
                
                // 获取近战武器伤害显示
                const getMeleeDamage = (weapon) => {
                    if (!isMeleeWeapon(weapon)) return null;
                    
                    let damageText = `左键: ${weapon.infobox.Body}`;
                    if (weapon.infobox["Alt-Fire"]) {
                        damageText += ` | 右键: ${weapon.infobox["Alt-Fire"]}`;
                    }
                    return damageText;
                };
                
                onMounted(() => {
                    initWeaponData();
                });
                
                return {
                    weapons,
                    searchQuery,
                    activeCategory,
                    activeView,
                    activeRanking,
                    selectedWeapons,
                    showCompare,
                    categories,
                    sortBy,
                    sortDirection,
                    filteredWeapons,
                    rankedWeapons,
                    isSelected,
                    toggleWeaponSelection,
                    clearSelection,
                    showCompareModal,
                    getBodyTTK,
                    getHeadTTK,
                    getBestTTKClass,
                    getBestValueClass,
                    isMeleeWeapon,
                    getMeleeDamage
                };
            }
        }).mount('#app');
</script>
</body>
</html>
